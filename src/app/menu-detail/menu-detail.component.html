@if (showSpinner) {

  <section class="dots-container">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </section>

}@else {
@if (showDeleteMenuMessage) {

<ngb-alert class="mt-5" type="success" [dismissible]="false">Menú eliminada correctamente</ngb-alert>
}

@if (menu)
{
<div class="menu-hero-section">
  <div class="container">
    <div class="row g-4 align-items-start">

      <!-- Imagen del menú -->
      <div class="col-md-5">
        <div class="menu-image-wrapper" [routerLink]="['/restaurant', menu.restaurant.id, 'detail']">
          @if (menu.imgMenu.startsWith('http')) {
          <img class="menu-image" [src]="menu.imgMenu" alt="{{menu.title}}">
          } @else {
          <img class="menu-image" [src]="'http://localhost:8080/files/' + menu.imgMenu" alt="{{menu.title}}">
          }
          <div class="image-overlay">
            <span class="view-restaurant">
              <i class="bi bi-arrow-right-circle-fill"></i>
              Ver Restaurante
            </span>
          </div>
        </div>
      </div>

      <!-- Información del menú -->
      <div class="col-md-7">
        <div class="menu-info-card">
          <div class="menu-header">
            <h1 class="menu-title">{{menu.title}}</h1>
          </div>

          <div class="menu-details-grid">
            <!-- Descripción -->
            <div class="detail-item">
              <div class="detail-label">
                <i class="bi bi-card-text"></i>
                Descripción
              </div>
              <div class="detail-value">{{menu.description}}</div>
            </div>

            <!-- Restaurante -->
            <div class="detail-item">
              <div class="detail-label">
                <i class="bi bi-shop"></i>
                Restaurante
              </div>
              <div class="detail-value">
                <a class="restaurant-link" [routerLink]="['/restaurant', menu.restaurant.id, 'detail']">
                  {{menu.restaurant.name}}
                  <i class="bi bi-arrow-right"></i>
                </a>
              </div>
            </div>

            <!-- Categoría -->
            <div class="detail-item">
              <div class="detail-label">
                <i class="bi bi-tag"></i>
                Categoría
              </div>
              <div class="detail-value">
                <span class="category-badge">{{getRestaurantType(menu.restaurantType)}}</span>
              </div>
            </div>
          </div>

          <div class="detail-badges">
            @if (menu.active) {
            <span class="status-badge active">
              <i class="bi bi-check-circle-fill"></i>
              Disponible
            </span>
            } @else {
            <span class="status-badge inactive">
              <i class="bi bi-x-circle-fill"></i>
              No disponible
            </span>
            }

            @if (menu.alergys) {
            <span class="status-badge warning">
              <i class="bi bi-exclamation-triangle-fill"></i>
              Contiene alérgenos
            </span>
            } @else {
            <span class="status-badge safe">
              <i class="bi bi-shield-check"></i>
              Sin alérgenos
            </span>
            }
          </div>

          @if (canEdit) {
          <div class="menu-actions">
            <button class="action-btn edit-btn" [routerLink]="['/menus', menu.id, 'update']">
              <i class="bi bi-pencil-square"></i>
              Editar
            </button>
            <button class="action-btn delete-btn" (click)="openModal(modal, menu)">
              <i class="bi bi-trash"></i>
              Eliminar
            </button>
          </div>
          }
        </div>
      </div>

    </div>
  </div>
</div>

<ng-template #modal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Despublicar Menú</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cancelar')"></button>
  </div>
  <div class="modal-body">
    <p>
      Esta acción va a despublicar el Menú, por lo que ya no será accesible ni se podrá comprar.
      ¿Está de acuerdo?
    </p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-success" (click)="modal.close('Aceptar')">
      <i class="bi bi-check-lg me-2"></i>
      Aceptar
    </button>
    <button type="button" class="btn btn-danger" (click)="modal.close('Cancelar')">
      <i class="bi bi-x-circle me-2"></i>
      Cancelar
    </button>
  </div>
</ng-template>

<section class="dishes-section">
  <div class="container">
    <!-- Header de sección estilo social -->
    <div class="dishes-section-header">
      <div class="section-tag">
        <i class="bi bi-fire"></i>
        <span>Destacados</span>
      </div>
      <h2 class="dishes-main-title">Platos Relevantes</h2>
      <p class="dishes-main-subtitle">Los favoritos de nuestros clientes</p>
    </div>

    <!-- Grid de platos tipo Instagram -->
    <div class="dishes-grid">
      @for (dish of dishes; track dish.id; let i = $index) {
      <article class="dish-card">
        <div class="dish-card-image">
          @if (dish.imgDish.startsWith('http')) {
          <img [src]="dish.imgDish" alt="{{dish.title}}">
          } @else {
          <img [src]="'http://localhost:8080/files/' + dish.imgDish" alt="{{dish.title}}">
          }
          
          <!-- Overlay con gradiente -->
          <div class="dish-card-overlay">
            <div class="dish-card-actions">
              <button class="dish-action-btn like-btn" title="Me gusta">
                <i class="bi bi-heart"></i>
              </button>
            </div>
          </div>

          <!-- Badge de precio -->
          <div class="dish-price-badge">
            <span class="price-amount">{{dish.price}}€</span>
          </div>

          <!-- Tag de posición si es destacado -->
          @if (i < 3) {
          <div class="dish-rank-badge">
            <i class="bi bi-trophy-fill"></i>
            <span>#{{i + 1}}</span>
          </div>
          }
        </div>

        <div class="dish-card-content">
          <h3 class="dish-card-title">{{dish.title}}</h3>
          <p class="dish-card-description">{{dish.description}}</p>
          
          <div class="dish-card-footer">
            <div class="dish-stats">
              <span class="dish-stat">
                <i class="bi bi-hand-thumbs-up-fill"></i>
                Popular
              </span>
            </div>
          </div>
        </div>
      </article>
      }
    </div>

    <!-- Sección del menú completo -->
    <div class="full-menu-wrapper">
      <div class="full-menu-header">
        <div class="menu-header-content">
          <div class="section-tag secondary">
            <i class="bi bi-book"></i>
            <span>Carta Completa</span>
          </div>
          <h2 class="menu-section-title">Toda nuestra carta</h2>
          <p class="menu-section-subtitle">Explora todas las opciones disponibles</p>
        </div>

        @if (canEdit) {
        <button type="button" [routerLink]="['/dishes', menu.id, 'create']" class="add-dish-btn">
          <i class="bi bi-plus-lg"></i>
          <span>Nuevo plato</span>
        </button>
        }
      </div>

      <!-- Lista de platos estilo feed -->
      <div class="menu-feed">
        @for (dish of dishes; track dish.id) {
        <article class="menu-feed-item">
          <div class="feed-item-image">
            @if (dish.imgDish.startsWith('http')) {
            <img [src]="dish.imgDish" alt="{{dish.title}}">
            } @else {
            <img [src]="'http://localhost:8080/files/' + dish.imgDish" alt="{{dish.title}}">
            }
          </div>
          
          <div class="feed-item-content">
            <div class="feed-item-header">
              <h4 class="feed-item-title">{{dish.title}}</h4>
              <span class="feed-item-price">{{dish.price}}€</span>
            </div>
            <p class="feed-item-description">{{dish.description}}</p>
            
            <div class="feed-item-actions">
              <button class="feed-action like-btn">
                <i class="bi bi-heart"></i>
              </button>
            </div>
          </div>
        </article>
        }

        @if (dishes.length === 0) {
        <div class="empty-menu-state">
          <i class="bi bi-emoji-frown"></i>
          <p>No hay platos disponibles en este menú</p>
        </div>
        }
      </div>
    </div>
  </div>
</section>

<div class="ratings-section">
  <div class="container py-5">
    <div class="section-header text-center">
      <h2 class="section-title">Experiencias de Nuestros Clientes</h2>
      <p class="section-subtitle">Descubre lo que opinan quienes ya disfrutaron de este menú</p>
    </div>

    <div class="ratings-two-columns">
      <!-- Columna izquierda: Formulario -->
      <div class="ratings-form-column">
        <div class="add-rating-section">
          <div class="add-rating-header">
            <i class="bi bi-star-fill header-icon"></i>
            <h3 class="add-rating-title">Comparte tu Experiencia</h3>
            <p class="add-rating-subtitle">Tu opinión nos ayuda a mejorar cada día</p>
          </div>

          <form [formGroup]="ratingForm" (ngSubmit)="save()" class="rating-form">

            <div class="form-group">
              <label class="form-label">
                <i class="bi bi-star-fill me-2"></i>
                Tu Calificación
              </label>
              <div class="rating-input-wrapper">
                <ngb-rating [max]="5" formControlName="score">
                  <ng-template let-fill="fill" let-index="index">
                    <i class="bi-star{{ fill === 100 ? '-fill' : '' }}" style="color: #ffc845; font-size: 1.5rem;"></i>
                  </ng-template>
                </ngb-rating>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="comment">
                <i class="bi bi-chat-dots-fill me-2"></i>
                Cuéntanos tu Experiencia
              </label>
              <textarea 
                class="form-control modern-textarea" 
                placeholder="¿Qué te pareció? Comparte tu opinión..." 
                id="comment" 
                formControlName="comment"
                rows="4"></textarea>
              @if (ratingForm.get('comment')?.invalid && ratingForm.get('comment')?.touched) {
              <p class="form-error">El comentario es obligatorio (máximo 1000 caracteres).</p>
              }
            </div>

            <!-- Sección de subida de imágenes -->
            <div class="form-group">
              <label class="form-label">
                <i class="bi bi-camera-fill me-2"></i>
                Agregar Fotos (Opcional)
              </label>
              <p class="form-helper-text">Comparte hasta 3 imágenes de tu experiencia</p>
          
              <div class="upload-images-grid">
                <!-- Imagen 1 -->
                <div class="upload-card">
                  @if (!previewImage1) {
                    <label for="image1" class="upload-label">
                      <div class="upload-content">
                        <i class="bi bi-camera-fill upload-icon"></i>
                        <span class="upload-text">Foto 1</span>
                      </div>
                    </label>
                    <input 
                      type="file" 
                      id="image1" 
                      class="upload-input" 
                      accept="image/*" 
                      (change)="onImageSelected($event, 1)">
                  } @else {
                    <div class="upload-preview">
                      <img [src]="previewImage1" alt="Preview 1" class="preview-image">
                      <button 
                        type="button" 
                        class="remove-image-btn" 
                        (click)="removeImage(1)">
                        <i class="bi bi-x-circle-fill"></i>
                      </button>
                    </div>
                  }
                </div>

                <!-- Imagen 2 -->
                <div class="upload-card">
                  @if (!previewImage2) {
                    <label for="image2" class="upload-label">
                      <div class="upload-content">
                        <i class="bi bi-camera-fill upload-icon"></i>
                        <span class="upload-text">Foto 2</span>
                      </div>
                    </label>
                    <input 
                      type="file" 
                      id="image2" 
                      class="upload-input" 
                      accept="image/*" 
                      (change)="onImageSelected($event, 2)">
                  } @else {
                    <div class="upload-preview">
                      <img [src]="previewImage2" alt="Preview 2" class="preview-image">
                      <button 
                        type="button" 
                        class="remove-image-btn" 
                        (click)="removeImage(2)">
                        <i class="bi bi-x-circle-fill"></i>
                      </button>
                    </div>
                  }
                </div>

                <!-- Imagen 3 -->
                <div class="upload-card">
                  @if (!previewImage3) {
                    <label for="image3" class="upload-label">
                      <div class="upload-content">
                        <i class="bi bi-camera-fill upload-icon"></i>
                        <span class="upload-text">Foto 3</span>
                      </div>
                    </label>
                    <input 
                      type="file" 
                      id="image3" 
                      class="upload-input" 
                      accept="image/*" 
                      (change)="onImageSelected($event, 3)">
                  } @else {
                    <div class="upload-preview">
                      <img [src]="previewImage3" alt="Preview 3" class="preview-image">
                      <button 
                        type="button" 
                        class="remove-image-btn" 
                        (click)="removeImage(3)">
                        <i class="bi bi-x-circle-fill"></i>
                      </button>
                    </div>
                  }
                </div>
              </div>
            </div>

            <button class="submit-rating-btn" type="submit" [disabled]="ratingForm.invalid">
              <i class="bi bi-send-fill me-2"></i>
              <span>Publicar Valoración</span>
            </button>
          </form>
        </div>
      </div>

      <!-- Columna derecha: Lista de ratings scrolleable -->
      <div class="ratings-list-column">
        <div class="ratings-list-header">
          <h4 class="ratings-list-title">
            <i class="bi bi-chat-quote-fill me-2"></i>
            Opiniones ({{ratings.length}})
          </h4>
        </div>
        
        <ul class="ratings-list list-unstyled">
          @for (rating of ratings; track rating.id) {
          <li class="rating-card">
            <div class="rating-card-content">
              <!-- Header con usuario -->
              <div class="rating-header">
                <div class="user-info">
                  <div class="avatar-wrapper">
                    @if (hasUserAvatar(rating.user?.imgUser)) {
                    <img
                      [src]="resolveUserAvatar(rating.user?.imgUser)"
                      class="user-avatar"
                      [routerLink]="['/user', rating.user!.id, 'detail']"
                      alt="Usuario">
                    } @else if (rating.user) {
                    <a class="avatar-placeholder" [routerLink]="['/user', rating.user!.id, 'detail']">{{ getUserInitials(rating.user) }}</a>
                    } @else {
                    <div class="avatar-placeholder avatar-placeholder-static">{{ getUserInitials(rating.user) }}</div>
                    }
                  </div>
                  <div class="user-details">
                    <h5 class="user-name">{{rating.user?.firstName}} {{rating.user?.lastName}}</h5>
                    <div class="rating-stars-wrapper">
                      <ngb-rating [(rate)]="rating.score" [max]="5" [readonly]="true">
                        <ng-template let-fill="fill" let-index="index">
                          <i class="bi-star{{ fill === 100 ? '-fill' : '' }}" style="color: #ffc845; font-size: 1rem;"></i>
                        </ng-template>
                      </ngb-rating>
                      @if (isAdmin) {
                      <button class="delete-rating-btn" (click)="deleteRating(rating)">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                      }
                    </div>
                  </div>
                </div>
                @if (rating.score != null) {
                <div class="rating-meta">
                  <span class="rating-score-pill">{{rating.score | number:'1.1-1'}}</span>
                </div>
                }
              </div>

              <!-- Comentario -->
              <div class="rating-comment">
                <p>{{rating.comment}}</p>
              </div>

              <!-- Footer con like -->
              <div class="rating-footer">
                <button 
                  class="rating-like-btn" 
                  [class.liked]="isRatingLiked(rating.id)"
                  [disabled]="isLikeLoading(rating.id)"
                  (click)="toggleLike(rating)"
                  title="Me gusta este comentario">
                  <i class="bi" [class.bi-heart-fill]="isRatingLiked(rating.id)" [class.bi-heart]="!isRatingLiked(rating.id)"></i>
                  <span class="like-count">{{rating.likesCount || 0}}</span>
                </button>
              </div>
              
              <!-- Galería de imágenes -->
              @if (rating.images?.length) {
                <div class="rating-gallery">
                  <div class="gallery-grid">
                    @for (image of rating.images; track image.id) {
                    <div class="gallery-card" (click)="openImageLightbox(resolveRatingImage(image))">
                      <div class="gallery-card-inner">
                        <img 
                          [src]="resolveRatingImage(image)" 
                          alt="Imagen de valoración"
                          class="gallery-image">
                        <div class="gallery-overlay">
                          <i class="bi bi-zoom-in"></i>
                        </div>
                      </div>
                    </div>
                    }
                  </div>
                </div>
              }
            </div>
          </li>
          }

          @if (ratings.length === 0) {
          <li class="no-ratings-message">
            <i class="bi bi-chat-left-dots"></i>
            <p>Aún no hay valoraciones. ¡Sé el primero en opinar!</p>
          </li>
          }
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox para imágenes -->
@if (lightboxImage) {
<div class="image-lightbox" (click)="closeLightbox()">
  <div class="lightbox-content" (click)="$event.stopPropagation()">
    <button class="lightbox-close" (click)="closeLightbox()">
      <i class="bi bi-x-lg"></i>
    </button>
    <img [src]="lightboxImage" alt="Imagen ampliada" class="lightbox-image">
  </div>
</div>
}


<div class="container mb-5">
  <div class="row">
    <div class="col">
      <!---Acordeon NgBootstrap-->

      <h2 class="mt-3 mb-3 text-center">Preguntas Frecuentes</h2>
      <div class="horizontal-bars"></div>
      <div ngbAccordion #accordion="ngbAccordion">
        <div ngbAccordionItem="first">
          <h2 ngbAccordionHeader>
            <button ngbAccordionButton>Tarifas de reseva.</button>
          </h2>
          <div ngbAccordionCollapse>
            <div ngbAccordionBody>
              <ng-template>
                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad
                squid. 3 wolf
                moon
                officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum
                eiusmod. Brunch
                3 wolf
                moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda
                shoreditch et.
                Nihil anim
                keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.
                Ad vegan
                excepteur
                butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth
                nesciunt you
                probably
                haven't heard of them accusamus labore sustainable VHS.
              </ng-template>
            </div>
          </div>
        </div>
        <div ngbAccordionItem="second">
          <h2 ngbAccordionHeader>
            <button ngbAccordionButton>Politicas de cancelación.</button>
          </h2>
          <div ngbAccordionCollapse>
            <div ngbAccordionBody>
              <ng-template>
                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad
                squid. 3 wolf
                moon
                officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum
                eiusmod. Brunch
                3 wolf
                moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda
                shoreditch et.
                Nihil anim
                keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.
                Ad vegan
                excepteur
                butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth
                nesciunt you
                probably
                haven't heard of them accusamus labore sustainable VHS.
              </ng-template>
            </div>
          </div>
        </div>
        <div ngbAccordionItem="three">
          <h2 ngbAccordionHeader>
            <button ngbAccordionButton>Consideraciones adicionales.</button>
          </h2>
          <div ngbAccordionCollapse>
            <div ngbAccordionBody>
              <ng-template>
                Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad
                squid. 3 wolf
                moon
                officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum
                eiusmod. Brunch
                3 wolf
                moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda
                shoreditch et.
                Nihil anim
                keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.
                Ad vegan
                excepteur
                butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic synth
                nesciunt you
                probably
                haven't heard of them accusamus labore sustainable VHS.
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <hr />


      <button class="btn btn-sm btn-outline-dark me-2" (click)="accordion.expandAll()">Abrir todos</button>
      <button class="btn btn-sm btn-outline-dark me-2" (click)="accordion.collapseAll()">Cerrar todos</button>
    </div>
  </div>
</div>

}
}