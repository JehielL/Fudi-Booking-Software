<div class="analytics-container">
  <!-- Header -->
  <div class="analytics-header">
    <div class="header-title">
      <i class="bi bi-graph-up"></i>
      <h2>Analytics</h2>
      @if (restaurantName) {
        <span class="restaurant-badge">{{ restaurantName }}</span>
      }
    </div>
    <div class="header-actions">
      <button class="refresh-btn" (click)="refresh()" [disabled]="loading">
        <i class="bi bi-arrow-clockwise" [class.spinning]="loading"></i>
        <span>Actualizar</span>
      </button>
    </div>
  </div>

  <!-- Selector de rango -->
  <div class="range-selector">
    <div class="preset-buttons">
      @for (preset of dateRangePresets; track preset.key) {
        <button 
          class="preset-btn" 
          [class.active]="selectedPreset === preset.key"
          (click)="selectedPreset = preset.key; onPresetChange()">
          {{ preset.label }}
        </button>
      }
    </div>
    
    @if (showCustomRange) {
      <div class="custom-range">
        <div class="date-inputs">
          <div class="date-field">
            <label>Desde</label>
            <input type="date" [(ngModel)]="customStartDate">
          </div>
          <div class="date-field">
            <label>Hasta</label>
            <input type="date" [(ngModel)]="customEndDate">
          </div>
          <button class="apply-btn" (click)="applyCustomRange()">
            <i class="bi bi-check-lg"></i> Aplicar
          </button>
        </div>
      </div>
    }
    
    @if (dateRangeLabel) {
      <div class="range-label">
        <i class="bi bi-calendar3"></i>
        {{ dateRangeLabel }}
      </div>
    }
  </div>

  <!-- Estados -->
  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando analytics...</p>
    </div>
  } @else if (error) {
    <div class="error-state">
      <i class="bi bi-exclamation-triangle"></i>
      <p>{{ error }}</p>
      <button class="retry-btn" (click)="refresh()">
        <i class="bi bi-arrow-clockwise"></i> Reintentar
      </button>
    </div>
  } @else if (!hasData) {
    <div class="empty-state">
      <i class="bi bi-calendar-x"></i>
      <h3>Sin datos</h3>
      <p>No hay reservas en el periodo seleccionado</p>
    </div>
  } @else {
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-icon">
          <i class="bi bi-bookmark-check"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ totalReservations }}</span>
          <span class="stat-label">Total Reservas</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">
          <i class="bi bi-calendar-day"></i>
        </div>
        <div class="stat-content">
          <span class="stat-value">{{ averagePerDay }}</span>
          <span class="stat-label">Media por día</span>
        </div>
      </div>
      
      @if (busiestDay) {
        <div class="stat-card success">
          <div class="stat-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value">{{ busiestDay.day }}</span>
            <span class="stat-label">Día más activo ({{ busiestDay.count }})</span>
          </div>
        </div>
      }
      
      @if (slowestDay) {
        <div class="stat-card warning">
          <div class="stat-icon">
            <i class="bi bi-graph-down-arrow"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value">{{ slowestDay.day }}</span>
            <span class="stat-label">Día más bajo ({{ slowestDay.count }})</span>
          </div>
        </div>
      }
    </div>

    <!-- Gráfico de barras -->
    <div class="chart-section">
      <h3 class="section-title">
        <i class="bi bi-bar-chart"></i>
        Distribución por día de la semana
      </h3>
      
      <div class="bar-chart">
        @for (item of chartData; track item.weekday) {
          <div class="bar-row">
            <div class="bar-label">
              <span class="day-name">{{ item.label }}</span>
              <span class="day-short">{{ item.shortLabel }}</span>
            </div>
            <div class="bar-container">
              <div 
                class="bar" 
                [style.width.%]="getBarWidth(item.count)"
                [style.background]="getBarColor(item)"
                [class.highest]="item.isHighest">
              </div>
              <span class="bar-value" [class.outside]="getBarWidth(item.count) < 20">
                {{ item.count }}
                @if (item.percentage > 0) {
                  <span class="percentage">({{ item.percentage }}%)</span>
                }
              </span>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Tabla resumen -->
    <div class="table-section">
      <h3 class="section-title">
        <i class="bi bi-table"></i>
        Resumen detallado
      </h3>
      
      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th>Día</th>
              <th>Reservas</th>
              <th>% del Total</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            @for (item of chartData; track item.weekday) {
              <tr [class.highlight]="item.isHighest">
                <td>
                  <span class="day-label">{{ item.label }}</span>
                </td>
                <td>
                  <span class="count-badge">{{ item.count }}</span>
                </td>
                <td>
                  <div class="percentage-bar">
                    <div class="fill" [style.width.%]="item.percentage"></div>
                    <span>{{ item.percentage }}%</span>
                  </div>
                </td>
                <td>
                  @if (item.isHighest) {
                    <span class="status-badge high">
                      <i class="bi bi-fire"></i> Más activo
                    </span>
                  } @else if (item.count === 0) {
                    <span class="status-badge empty">
                      <i class="bi bi-dash-circle"></i> Sin datos
                    </span>
                  } @else if (item.percentage < 10) {
                    <span class="status-badge low">
                      <i class="bi bi-arrow-down"></i> Bajo
                    </span>
                  } @else {
                    <span class="status-badge normal">
                      <i class="bi bi-check"></i> Normal
                    </span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</div>
